AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation tempate for VPC with public and private subnets.
Parameters:
  SSHLocation:
    Description: Lockdown SSH access to the bastion host (default can be accessed
      from anywhere)
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
    ConstraintDescription: must be a valid CIDR range of the form x.x.x.x/x.
  SecurityGroupBastion:
    Description: Security Group for bastion host
    Type: AWS::EC2::SecurityGroup::Id
  SubnetIdBastion:
    Description: SubnetId for bastion host
    Type: AWS::EC2::Subnet::Id
  KeyNameBastion:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: AWS::EC2::KeyPair::KeyName
Resources:
  BastionHost:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-1a962263
      Keyname:
        Ref: KeyNameBastion
      SubnetId:
        Ref: SubnetIdBastion
      PrivateIpAddress:
        Ref: SSHLocation
      SecurityGroups:
        - Ref: SecurityGroupBastion
      Tags:
      - Key: Name
        Value:
          Ref: AWS::StackName
      - Key: Application
        Value:
          Ref: AWS::StackName
      - Key: Network
        Value: Public
  IPAddress:
    Type: AWS::EC2::EIP
  IPAssoc:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId:
        Ref: BastionHost
      EIP:
        Ref: IPAddress
Outputs:
  InstanceIdBastion:
    Description: InstanceId of the newly created Bastion Host
    Value:
      Ref: BastionHost
  InstanceIPAddressBastion:
    Description: IP address of the newly created EC2 Bastion Host
    Value:
      Ref: IPAddress
